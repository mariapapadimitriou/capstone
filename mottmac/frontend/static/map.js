
mapboxgl.accessToken = "pk.eyJ1IjoibWFyaWFwYXBhZGltaXRyaW91IiwiYSI6ImNreGF6eThsNjJyb2szMHBtbWplc2Z6dWoifQ.Em5B1yYl9AT6jPMlmM1b4w";

const geojson = {
    "version": 0.6,
    "generator": "Overpass API 0.7.57.1 74a55df1",
    "osm3s": {
      "timestamp_osm_base": "2021-11-16T16:06:44Z",
      "copyright": "The data included in this document is from www.openstreetmap.org. The data is made available under ODbL."
    },
    "elements": [
        {
            "type": "node",
            "id": 20979738,
            "lat": 43.6659368,
            "lon": -79.3918763,
            "tags": {
              "button_operated": "yes",
              "crossing": "traffic_signals",
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 20979746,
            "lat": 43.6651098,
            "lon": -79.3939147,
            "tags": {
              "crossing": "traffic_signals",
              "highway": "crossing"
            }
          },
          {
            "type": "node",
            "id": 20979760,
            "lat": 43.6575265,
            "lon": -79.3896244,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 20979761,
            "lat": 43.6575829,
            "lon": -79.3893464,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 21436517,
            "lat": 43.6598263,
            "lon": -79.3905908,
            "tags": {
              "highway": "traffic_signals",
              "protected_left_turn": "s"
            }
          },
          {
            "type": "node",
            "id": 21436518,
            "lat": 43.6598822,
            "lon": -79.3903312,
            "tags": {
              "highway": "traffic_signals",
              "protected_left_turn": "s"
            }
          },
          {
            "type": "node",
            "id": 21631731,
            "lat": 43.6640762,
            "lon": -79.3984403,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 21631733,
            "lat": 43.6630941,
            "lon": -79.4019954,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959504,
            "lat": 43.6643769,
            "lon": -79.3871554,
            "tags": {
              "highway": "traffic_signals",
              "permissive_left_turn": "w"
            }
          },
          {
            "type": "node",
            "id": 24959505,
            "lat": 43.6656549,
            "lon": -79.3876919,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959509,
            "lat": 43.6624808,
            "lon": -79.386369,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959510,
            "lat": 43.6615668,
            "lon": -79.386094,
            "tags": {
              "highway": "traffic_signals",
              "traffic_signals": "signal"
            }
          },
          {
            "type": "node",
            "id": 24959511,
            "lat": 43.6608075,
            "lon": -79.3858484,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959512,
            "lat": 43.6612236,
            "lon": -79.3876917,
            "tags": {
              "highway": "stop"
            }
          },
          {
            "type": "node",
            "id": 24959515,
            "lat": 43.6605206,
            "lon": -79.3873978,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959516,
            "lat": 43.6581872,
            "lon": -79.3863686,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959535,
            "lat": 43.6634971,
            "lon": -79.4000445,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959539,
            "lat": 43.6646701,
            "lon": -79.4026205,
            "tags": {
              "highway": "traffic_signals",
              "note": "No left turn from Spadina"
            }
          },
          {
            "type": "node",
            "id": 24959542,
            "lat": 43.6659399,
            "lon": -79.4010187,
            "tags": {
              "highway": "stop"
            }
          },
          {
            "type": "node",
            "id": 24959543,
            "lat": 43.6650766,
            "lon": -79.4006727,
            "tags": {
              "highway": "stop",
              "stop": "all"
            }
          },
          {
            "type": "node",
            "id": 24959546,
            "lat": 43.6654314,
            "lon": -79.398973,
            "tags": {
              "highway": "stop",
              "note": "No left turn from St. George NB, 3:30-6:30p M-F",
              "stop": "all"
            }
          },
          {
            "type": "node",
            "id": 24959549,
            "lat": 43.6620826,
            "lon": -79.3976065,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959553,
            "lat": 43.6613168,
            "lon": -79.4012896,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959556,
            "lat": 43.6600802,
            "lon": -79.3986803,
            "tags": {
              "highway": "stop",
              "note": "No stop signs facing middle of these two intersections"
            }
          },
          {
            "type": "node",
            "id": 24959557,
            "lat": 43.6600368,
            "lon": -79.3988896,
            "tags": {
              "highway": "stop",
              "note": "No stop signs facing middle of these two intersections"
            }
          },
          {
            "type": "node",
            "id": 24959569,
            "lat": 43.659659,
            "lon": -79.3998677,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24959584,
            "lat": 43.6594997,
            "lon": -79.4015277,
            "tags": {
              "highway": "traffic_signals"
            }
          },
          {
            "type": "node",
            "id": 24960090,
            "lat": 43.663141,
            "lon": -79.3927677,
            "tags": {
              "highway": "stop"
            }
          }
    ]};
    
const map = new mapboxgl.Map({
container: 'app', // container ID
style: 'mapbox://styles/mapbox/light-v9', // style URL
center: [-79.347015, 43.651070], // starting position [lng, lat]
zoom: 12, // starting zoom
maxBounds: [-79.644849,43.553266,-79.068067,43.849127]
});

  // add markers to map
  for (const feature of geojson.elements) {
    // create a HTML element for each feature
    const el = document.createElement('div');
    el.className = 'marker';

    // make a marker for each feature and add it to the map
    new mapboxgl.Marker(el, {
      draggable: false,

    }).setLngLat([feature.lon, feature.lat]).addTo(map);
  }
  

  const draw = new MapboxDraw({
    // Instead of showing all the draw tools, show only the line string and delete tools.
    displayControlsDefault: false,
    controls: {
      line_string: true,
      trash: true
    },
    // Set the draw mode to draw LineStrings by default.
    defaultMode: 'draw_line_string',
    styles: [
      // Set the line style for the user-input coordinates.
      {
        id: 'gl-draw-line',
        type: 'line',
        filter: ['all', ['==', '$type', 'LineString'], ['!=', 'mode', 'static']],
        layout: {
          'line-cap': 'round',
          'line-join': 'round'
        },
        paint: {
          'line-color': 'black',
          'line-dasharray': [0.2, 2],
          'line-width': 4,
          'line-opacity': 0.7
        }
      },
      // Style the vertex point halos.
      {
        id: 'gl-draw-polygon-and-line-vertex-halo-active',
        type: 'circle',
        filter: [
          'all',
          ['==', 'meta', 'vertex'],
          ['==', '$type', 'Point'],
          ['!=', 'mode', 'static']
        ],
        paint: {
          'circle-radius': 12,
          'circle-color': '#FFF'
        }
      },
      // Style the vertex points.
      {
        id: 'gl-draw-polygon-and-line-vertex-active',
        type: 'circle',
        filter: [
          'all',
          ['==', 'meta', 'vertex'],
          ['==', '$type', 'Point'],
          ['!=', 'mode', 'static']
        ],
        paint: {
          'circle-radius': 8,
          'circle-color': 'black'
        }
      }
    ]
  });

  const colours = ['#36b9cc', "#4e73df", "#1cc88a"];
  var id_colours = {}

  function createRoute() {
    // Set the profile
    const profile = 'driving';
    // Get the coordinates that were drawn on the map

    const data = draw.getAll();
    const lastFeature = data.features.length - 1;
    const coords = data.features[lastFeature].geometry.coordinates;
    // Format the coordinates
    const newCoords = coords.join(';');
    // Set the radius for each coordinate pair to 25 meters
    const radius = coords.map(() => 25);

    for (let i = 0; i < draw.getAll().features.length; i++) {
      const routeid = draw.getAll().features[i].id
      const routeidx = i

      if (typeof map.getLayer(routeid) == 'undefined') {
        
        getMatch(newCoords, radius, profile, routeid, routeidx);
      }
    }
  }

function updateRoute() {
    // Set the profile

    const profile = 'driving';
    // Get the coordinates that were drawn on the map

    const data = draw.getAll();
    const lastFeature = data.features.length - 1;

    const coords = data.features[lastFeature].geometry.coordinates;
    // Format the coordinates
    const newCoords = coords.join(';');
    // Set the radius for each coordinate pair to 25 meters
    const radius = coords.map(() => 25);

    const routeid = draw.getAll().features[lastFeature].id

    if (typeof map.getLayer(routeid) !== 'undefined') {
      map.removeLayer(routeid)
      map.removeSource(routeid)
      getMatch(newCoords, radius, profile, routeid, lastFeature);
    }
  }


// Make a Map Matching request
async function getMatch(coordinates, radius, profile, routeid, routeidx) {
  // Separate the radiuses with semicolons
  const radiuses = radius.join(';');
  // Create the query
  const query = await fetch(
    `https://api.mapbox.com/matching/v5/mapbox/${profile}/${coordinates}?geometries=geojson&radiuses=${radiuses}&steps=true&access_token=${mapboxgl.accessToken}`,
    { method: 'GET' }
  );
  const response = await query.json();
  // Handle errors
  if (response.code !== 'Ok') {
    alert(
      `${response.code} - ${response.message}.\n\nFor more information: https://docs.mapbox.com/api/navigation/map-matching/#map-matching-api-errors`
    );
    return;
  }
  // Get the coordinates from the response
  const coords = response.matchings[0].geometry;
  // Draw the route on the map
  
  addRoute(coords, routeid, routeidx);
}

// Draw the Map Matching route as a new layer on the map
function addRoute(coords, routeid, routeidx) {
      // Add a new layer to the map

      map.addLayer({
        id: routeid,
        type: 'line',
        source: {
          type: 'geojson',
          data: {
            type: 'Feature',
            properties: {},
            geometry: coords
          }
        },
        layout: {
          'line-join': 'round',
          'line-cap': 'round',
          visibility: 'visible',
        },
        paint: {
          'line-color': colours[routeidx],
          'line-width': 4,
          'line-opacity': 1
        }
      });
      id_colours[routeid] = colours[routeidx]
      updateLegend()
  }

  function removeRoute(routeid) {
    const id = routeid.features[0].id
    if (!map.getSource(id)) return;
    map.removeLayer(id);
    map.removeSource(id);
    updateLegend()
  }

  map.addControl(
    new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        bbox: [-79.644849,43.553266,-79.068067,43.849127], // Boundary for Toronto
    }),
    "top-right"
);

    // Add the draw tool to the map.
  map.addControl(draw);

  map.on('draw.create', createRoute);
  map.on('draw.update', updateRoute);
  map.on('draw.delete', removeRoute);

map.addControl(new mapboxgl.FullscreenControl());

function updateLegend() {

  const answer = document.getElementById('legend');
  var routes = []

  if (draw.getAll().features.length >= 1) {
    for (let i = 0; i < draw.getAll().features.length; i++) {
      const routeid = draw.getAll().features[i].id

      routes.push("<p style='color:")
      routes.push(id_colours[routeid])
      routes.push(";'>")
      routes.push("Route")
      routes.push(i+1)
      routes.push("</p>")
    
      answer.innerHTML = routes.join(" ");
    }
  }
  else {
    answer.innerHTML = "";
  }
}

